---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: azb-deployment
  labels:
    app: redis
spec:
  replicas: 1
    #strategy:
    #type: RollingUpdate
    #rollingUpdate:
    #maxSurge: 2        # how many pods we can add at a time
    #maxUnavailable: 0
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      hostname: redis-host
      subdomain: azb-clusterip
      containers:
      - name: azb-container
        # image: mcr.microsoft.com/oss/bitnami/redis:6.0.8
        image: redis:latest
        # args: ["dir", "/mnt/database",  "--requirepass", "$(REDIS_PWD)"]
        args: ["--requirepass", "$(REDIS_PWD)"]
        # volumeMounts:
        # - mountPath: "/mnt/database"
        #   name: mypd
        env:
        - name: ALLOW_EMPTY_PASSWORD
          value: "no"
        - name: REDIS_PWD
          valueFrom:
            secretKeyRef:
              name: redis-secret-duna
              key: password
        ports:
        - containerPort: 6379
      # volumes:
      #  - name: mypd
      #    persistentVolumeClaim:
      #      claimName: azure-managed-disk

---
apiVersion: v1
kind: Service
metadata:
  name: azb-clusterip
spec:
  ports:
  - port: 6379
  selector:
    app: redis

# ==== CLIENT SIDE ==== 
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: azf-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: votingapp
  template:
    metadata:
      labels:
        app: votingapp
    spec:
      containers:
      - name: azf-container
        image: whujin11e/public:azure_voting_app
        ports:
        - containerPort: 80
        env:
          - name: REDIS
            value: "redis-host.azb-clusterip"
          - name: STRESS_SECS
            value: "0"
          - name: REDIS_PWD
            valueFrom:
              secretKeyRef:
                name: redis-secret-duna
                key: password
---
apiVersion: v1
kind: Service
metadata:
  name: azf-loadbalancer
spec:
  type: LoadBalancer
  ports:
    - port: 80
  selector:
    app: votingapp
